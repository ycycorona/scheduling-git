<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>模拟机排班</title>
    <link rel='stylesheet' href='resource/lib/bootstrap/dist/css/bootstrap.css'/>
    <link rel='stylesheet' href='resource/lib/fullcalendar/dist/fullcalendar.css'/>
    <link rel='stylesheet' href='resource/lib/fullcalendar-scheduler/dist/scheduler.css'/>
    <link rel='stylesheet' href='resource/css/custom-style/base-css.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/style.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/base.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/animate.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/font-awesome.min.css'/>
    <link rel='stylesheet' href='resource/lib/layer/skin/layer.css'/>
    <link rel='stylesheet' href='resource/lib/select2/css/select2.min.css'/>
    <link rel='stylesheet' href='resource/lib/select2/css/select2-bootstrap.min.css'/>
    <link rel='stylesheet' href='resource/lib/clockpicker/bootstrap-clockpicker.min.css'/>
    <link rel='stylesheet' href='resource/lib/bootstrap-datetimepicker/bootstrap-datetimepicker.css'/>
    <link rel='stylesheet' href='resource/css/machine_schedule.css'/>
</head>
<body class="gray-bg">
<div class="no-margin-container">
    <div class="margin-top"></div>
    <div class="row">
        <!--模板放置区-->
        <div class="col-xs-2 " >
            <div class="left-section">
                <!--vue control-->
                <div class="ibox float-e-margins" id="tpl-wrap">
                    <div class="ibox-title ibox-title-blue">
                        <h5><i class="fa fa-pencil"></i>&nbsp;排班模板</h5>
                    </div>
                    <div class="ibox-content">
                        <div class="btn-group " id="table0-toolbar" role="group" >
                            <button
                                    @click="vOpenLayerCreateTpl"
                                    type="button"
                                    class="btn btn-outline btn-default btn-add"
                                    data-toggle="tooltip"
                                    title="添加">
                                <i class="fa fa-plus" aria-hidden="true"></i>
                            </button>
                        </div>
                            <!--测试说明-->
                        <div class="ui-widget-content external-event-box" >
                            <class-tpl
                                    @dblclick.native="openLayerEditTpl(item)"
                                    v-for="(item, index) in tplList"
                                    :tpl="item"
                                    :tpl-index="index"
                                    :key="index"></class-tpl>
                        </div>
                        <div class="user-help">
                            <h3>简单说明</h3>
                            <p>一、排班模板使用</p>
                            <p>1、双击上方的每个模板，可以编辑、删除模板。</p>
                            <p>2、点击上方的<i aria-hidden="true" class="fa fa-plus"></i>，可以添加新模板。</p>
                            <p>3、模板拖拽到排班表中，可以生成新课程。</p>
                            <p>二、排班表使用</p>
                            <p>1、拖拽每个课程到排班表的不同位置，可以指定课程的时间</p>
                            <p>2、单击排班表中的空白方块，可以添加新的课程。</p>
                            <p>3、排班表单击每个课程，可以编辑参加课程的学员、教员、检查员、并且可以在有特殊需求时，自行调整上课时间</p>
                            <p>4、每个自定义了上课时间的课程上鼠标悬浮，会提示自定义时间;如果备注超出显示长度，也会提示备注</p>
                            <p>5、激活快速删除模式，点击人名可以把该人从课程中删除</p>
                        </div>
                        <button class="btn btn-default" type="button" id="data-package" style="display: block;">
                            get data
                        </button>
                    </div>
                </div>

            </div>
        </div>
        <!--排班表放置区-->
        <div class="col-xs-10">
            <div class="ibox float-e-margins">
                <div class="ibox-title ibox-title-blue">
                    <h5><i class="fa fa-pencil"></i>&nbsp;排班表</h5>
                </div>
                <div class="ibox-content">

                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--layer弹窗，新建、编辑排班事件-->
<div class="wrapper wrapper-content layer-body" id="layer-body" style="display:none;">
    <form class="form-horizontal" >
        <div class="form-group">
            <label class="col-sm-3 control-label">学员</label>
            <div class="col-sm-7">
                <select id="select-students"></select>
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-3 control-label">教员</label>
            <div class="text-left col-sm-7">
                <select id="select-teachers"></select>
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-3 control-label">检查员</label>
            <div class="text-left col-sm-7">
                <select id="select-inspectors"></select>
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-3 control-label">备注</label>
            <div class="text-left col-sm-7">
                <textarea class="form-control" id="input-log" rows="3"></textarea>
            </div>
        </div>
        <div class="form-group" id="diy-time-control">
            <div class="text-left col-sm-7 col-sm-offset-3">
                <label>
                    <input type="checkbox" id="is-diy-time">自定义课程时间
                </label>
            </div>
        </div>
        <div class="form-group" id="diy-time-wrap" style="display: none">
            <label  class="col-sm-1 col-sm-offset-2 control-label">始：</label>
            <div class="text-left col-sm-3">
                <div class="input-group clockpicker" id="class-time-start">
                    <input type="text" class="form-control"  name="class-time-start">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
            </div>
            <label  class="col-sm-1 control-label">终：</label>
            <div class="text-left col-sm-3">
                <div class="input-group clockpicker" id="class-time-end">
                    <input type="text" class="form-control"  name="class-time-end">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
            </div>
        </div>
    </form>
</div>
<!--模拟机新建面-->
<div class="wrapper wrapper-content layer-body" id="layer-body-1" style="display:none;">
    <form class="form-horizontal" >
        <div class="form-group">
            <label class="col-sm-3 control-label">日期</label>
            <div class="col-sm-7">
                <input type="text" id="create-machine-date" class="form-control"  name="create-machine-date">
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-3 control-label">模拟机名称</label>
            <div class="text-left col-sm-7">
                <input type="text" id="create-machine-name" class="form-control"  name="create-machine-name">
            </div>
        </div>
    </form>
</div>
<!--模拟机删除页面-->
<div class="wrapper wrapper-content layer-body" id="layer-body-2" style="display:none;">
    <form class="form-horizontal" >
        <div class="form-group">
            <label class="col-sm-3 control-label">日期</label>
            <div class="col-sm-7">
                <input type="text" id="select-machine-date" class="form-control"  name="select-machine-date">
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-3 control-label">模拟机名称</label>
            <div class="text-left col-sm-7">
                <select id="select-machine-name"></select>
            </div>
        </div>
    </form>
</div>
<!--模板区，复制用-->
<div id="template" style="display: none">
    <!--渲染每个事件用到的模板-->
    <div class="box-wrap ">
        <div class="no-margin item-wrap student">

        </div>
        <div class="row no-margin item-wrap teacher inspector">

        </div>
        <div class="class-desc item-wrap log">

        </div>
    </div>
    <!--日历的工具栏-->
    <div class="calendar-tool">
        <div class="btn-group" style="position: relative;">
            <input type="text" placeholder="请选择日期" style="width:100px;height: 25px;"
                   class="table-tool-btn search-input pull-left" id="class-table-date-picker"/>
            <button type="button" class="btn btn-outline btn-success date-control"
                    data-toggle="tooltip" title="前一天" id="prev-date-btn">
                <i class="fa fa-arrow-left"></i>
            </button>

            <button type="button" class="btn btn-outline btn-success date-control"
                    data-toggle="tooltip" title="后一天" id="next-date-btn">
                <i class="fa fa-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

<script src='resource/lib/jquery/dist/jquery.js'></script>
<script src='resource/lib/vue.js'></script>
<script src='resource/lib/jquery-ui-1.12.1/jquery-ui.min.js'></script>
<script src='resource/lib/bootstrap/dist/js/bootstrap.js'></script>
<script src='resource/lib/moment/min/moment.min.js'></script>
<script src='resource/lib/fullcalendar/dist/fullcalendar.js'></script>
<script src='resource/lib/fullcalendar-scheduler/dist/scheduler.js'></script>
<script src='resource/lib/layer/layer.js'></script>
<script src='resource/lib/select2/js/select2.min.js'></script>
<script src='resource/lib/clockpicker/jquery-clockpicker.min.js'></script>
<script src='resource/lib/clockpicker/bootstrap-clockpicker.min.js'></script>
<script src='resource/lib/bootstrap-datetimepicker/bootstrap-datetimepicker.js'></script>
<script src='resource/lib/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js'></script>
<!--事件模板的 vue component-->
<script type="x-template" id="class-tpl">
    <div class="row">
        <div class="col-xs-1" style="padding: 0" :style="{height: rightHeight + 'px'}">
            <i
            @click="cancelTpl(tpl)"
            class="fa fa-trash-o cancel-tpl"
            style="font-size: 16px;position: absolute;"
            :style="{top: (rightHeight/2 - 10) + 'px', left: (leftWidth/2 - 8) + 'px'}"></i>
        </div>
        <div
            :data-event="dataEvent"
            class="fc-content fc-event col-xs-11"
            v-bindDrag="tpl"
            v-bindGetHeight="tplIndex"
            v-activeDataEventChange>
            <div class="box-wrap">
                <div class="no-margin item-wrap student">
                    <span class="card-item person student-item" v-for="(item, index) in tpl.students" :key="index">{{item.name}}</span>
                </div>
                <div class="row no-margin item-wrap teacher inspector">
                    <span class="card-item person teacher-item" v-for="(item, index) in tpl.teachers" :key="index">{{item.name}}</span>
                    <span class="card-item person inspector-item" v-for="(item, index) in tpl.inspectors" :key="index">{{item.name}}</span>
                </div>
                <div class="class-desc item-wrap log">
                    <span>{{tpl.log}}</span>
                </div>
            </div>
        </div>
    </div>
</script>
<script>
    /*左侧悬浮*/
    $(window).on('scroll',function (e) {
        console.log();
        var leftWidth = $('.left-section').outerWidth();
        if ($(this).scrollTop() > 50) {
            $('.left-section').addClass('fix-to-top');
            $('.left-section').css({'width': leftWidth});
        } else {
            $('.left-section').removeClass('fix-to-top');
            $('.left-section').css({'width': ''});
        }
    });
    /*插件参数重置*/
    $.fn.select2.defaults.set( "theme", "bootstrap" ); //使用select2-bootstrap主题
    moment.fn.toJSON = function() { return this.format()}; //处理时区的问题
    //事件模板 vue component
    var vueComponentsTplList = [];
    var classTpl = {
        props:{
            tpl: {
                type: Object,
                required: true,
                default: {
                    id: '1'
                }
            },
            tplIndex: {
                type: Number,
                required: true
            }
        },
        template:'#class-tpl',
        created: function () {
            vueComponentsTplList.push(this); /*设置模板的全局变量，这样才能在函数里用this调用*/
        },
        computed: {
            //绑定data-event,拖拽到日历时用到的数据
            dataEvent: function () {
                var tmpObj = {
                    title: 'test',
                    id: this.tpl.id,
                    duration: '02:00',
                    stick: true
                };
                $(this.$el).data('event', tmpObj);
                return JSON.stringify(tmpObj);
            }
        },
        data:function () {
          return{
              msg:'test',
              rightHeight: 0, //右侧的高度
              leftWidth: 0
          }
        },
        methods:{
            cancelTpl: function (tpl) {
                tplList.splice(tplListMap[tpl.id], 1); //删除tpl
                tplListMap = getArrayMapById(tplList);//重新生成tpl map
            }
        },
        directives: {
            activeDataEventChange: {
                update: function (el, binding) {
                    /*$.attr('data-event')的信息不会自动更新到$().data()；需要手动更新*/
                    console.log($(el).data().event = JSON.parse($(el).attr('data-event'))) ;
                }
            },
            bindDrag: {
                /*插入时绑定拖拽事件*/
                inserted: function (el, binding) {
                    // make the event draggable using jQuery UI
                    $(el).draggable({
                        scroll: false,
                        zIndex: 999,
                        revert: true,      // will cause the event to go back to its
                        revertDuration: 0  //  original position after the drag
                    });
                }
            },
            bindGetHeight: {
                inserted: function (el, binding) {
                    var _this = vueComponentsTplList[binding.value];
                    _this.rightHeight = $(el).outerHeight();
                    _this.leftWidth = $(el).prev().innerWidth();
                },
                update: function (el, binding) {
                    setTimeout(function () {
                        var _this = vueComponentsTplList[binding.value];
                        _this.rightHeight = $(el).outerHeight();
                        _this.leftWidth = $(el).prev().innerWidth();
                    },500);
                }
            }
        }
    };
    var _lg = console.log;
    /*全局变量初始化*/
    var globalVar = {};
    globalVar.currentDate = ''; //当前显示的月份
    var thisDate = '2017-01-01'; //把fullcalendar的日期写死，因为不在日历插件里涉及日期
    var layerTipIndex; //layer tip的index，close用
    /*日历的配置文件 timeLineOpt控制日历的显示*/
    /*此时代表 一天上4节大课，最多可分成8节小课*/
    var timeLineOpt = {
        minTime: {hours: 0, minutes: 0}, //开始时间
        maxTime: {hours: 8, minutes: 0}, //结束时间
        slotDuration: {hours:1, minutes:0}, //表格内部块，一个块代表几个小时，小课时长
        slotLabelInterval: {hours:2, minutes:0} //标题一个块代表几个小时， 大课时长
    };
    /*实际业务逻辑*/
    var displayOpt ={
        //resourceColor_1: 'rgb(81, 183, 73)', 绿色
        //resourceColor_2: 'rgb(164, 189, 252)' 蓝色
        resourceColor_1: '#3b91ad', //蓝色
        resourceColor_2: '#3b91ad' //蓝色
    };
    var classOpt = {
        classNum:4, //课时数
        minClassNum: 8,  //每天最多的课时数
        classDuration: '04:00:00', //课时长
        minClassDuration: '02:00:00', //小课时长
        /*一天的课程安排时间*/
        classArrange: [
            {
                name: '第一场',
                time: '08:00-12:00'
            },
            {
                name: '第二场',
                time: '12:15-16:15'
            },
            {
                name: '第三场',
                time: '16:30-20:30'
            },
            {
                name: '第四场',
                time: '20:45-00:45'
            }
        ]
    }; //课程选项
    var classList = []; //模拟的后台数据 事件列表
    var tplList = []; //模板列表
    var tplListMap = {}; //模板列表
    var userList = []; //模拟的人员数据
    var eventDragFromExternal = {}; //事件是否还未拖拽入日历
    /*远程获取数据*/
    $.ajax({
        type: "get",
        async: false,
        url: "mockData/class_list.json",
        dataType: 'json',
        success: function (data) {
            classList = data;
        }
    });
    var Dateobj = generateResourceArray(classList); /*通过远程获取的原始数据生成一个对象,包含event数组以及resource数组*/
    var eventsList = Dateobj.eventsList; //事件列表
    $.ajax({
        type: "get",
        async: false,
        url: "mockData/tpl_list.json",
        dataType: 'json',
        success: function (data) {
            tplList = data;
            tplList.forEach(function (tpl, index, thisArray) {
                tpl.id = parseInt(moment().format('x')) + index; //用时间戳作为ID
                eventDragFromExternal[tpl.id] = true;
                //console.log('tpl.id ' + tpl.id );
            }); //给刚加载的模板，设置id

            tplListMap = getArrayMapById(tplList); //生成map
        }
    });
    /*生成模拟的人员数据*/
    $.ajax({
        type: "get",
        async: false,
        url: "mockData/user.json",
        dataType: 'json',
        success: function (data) {
            userList = data;
        }
    });
    var eventsListMap = getArrayMapById(eventsList); /*事件资源数组的map*/
    //console.log(Dateobj, eventsListMap);
    var vueCon = new Vue({
        el: '#tpl-wrap',
        components: {
            'class-tpl': classTpl
        },
        data: {
            tplList: tplList
        },
        methods: {
            vOpenLayerCreateTpl: openLayerCreateTpl,
            openLayerEditTpl: openLayerEditTpl
        }
    });
    $(document).ready(function () {
        /*checkbox事件绑定*/
        $('#is-diy-time').on('change', function (e) {
            if ($(this).prop('checked')) {
                $('#diy-time-wrap').show();
            } else {
                $('#diy-time-wrap').hide();
            }
        });
        /*新建选择框选择项目初始化*/
        $('#select-students').select2({
            placeholder: '选择学员',
            data:userList,
            multiple: true
        });
        $('#select-teachers').select2({
            placeholder: '选择教员',
            data:userList,
            multiple: true
        });
        $('#select-inspectors').select2({
            placeholder: '选择检查员',
            data:userList,
            multiple: true
        });

        //日程表的配置
        var calendarOpt = {
            schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
            now: '2017-01-01', //当前时间
            selectable: true, //是否可以单击选择
            eventOverlap: false, /*事件之间是否可以重叠*/
            /*空日历选择之后的回调函数*/
            select: function (start, end, jsEvent, view, resource) {
                /*此处的start和end不带+08:00，需要自己加上*/
                openCreateLayer(start, end, resource); //打开新建事件的弹窗
            },
            /*事件的点击事件*/
            eventClick: function(event, element) {
                //console.log(event);
                openEditLayer(event, element); //打开编辑事件的弹窗
            },
            /*事件的鼠标进入事件*/
            eventMouseover: eventMouseoverFun,
            /*事件的鼠标出事件*/
            eventMouseout: eventMouseoutFun,
            /*日历内的事件拖拽 改变start和end*/
            eventDrop: function (event, delta, revertFunc, jsEvent, ui, view) {
                changeEventByDrag(event);
            },
            /*日历内的事件改变形状 改变start和end*/
            eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                changeEventByDrag(event);
            },
            /*外部事件拖拽事件*/
            drop:function (date, jsEvent, ui, resourceId ) {
                //console.log(date, jsEvent, ui, resourceId);
                //貌似此时设置id已经晚了
                //$(this).data().event.id = Dateobj.eventsList[3].id;
            },
            /*外部事件被接受事件*/
            eventReceive: function (event) {

            },
            editable: true, //是否可以拖拽编辑duration、起始时间
            droppable: true, //是否可以放置事件
            aspectRatio: 2, //宽高比
            resourceAreaWidth: '20%', /*左侧资源区的宽度*/
            customButtons: { //自定义按钮
                toggleClickMode: {
                    text: '快速删除模式已关闭',
                    click: toggleClickModeEvent
                },
                openLayerCreateMachine: {
                    text: '增加模拟机',
                    click: openLayerCreateMachine
                },
                openLayerDeleteMachine: {
                    text: '删除模拟机',
                    click: openLayerDeleteMachine
                }
            },
            header: {
                left: '',
                center: '',
                right: 'toggleClickMode openLayerCreateMachine openLayerDeleteMachine'
            },
            defaultView: 'timelineDay', //默认视图
            /*视图设置*/
            views: {
                timelineDay: {
                    type: 'timeline',
                    duration: {days: 1}, //事件线长度 默认1天
                    slotDuration: {hours:1, minutes:0} , //表格内部块，一个块代表几个小时
                    slotLabelFormat: [
                        'kk:mm'  // top level of text*/
                    ], //标题事件显示格式
                    slotLabelInterval: {hours:2, minutes:0}, //标题一个块代表几个小时
                    buttonText: '1DAY',
                    scrollTime: '00:00',
                    minTime: {hours: 0, minutes: 0},
                    maxTime: {hours: 8, minutes: 0}
                }
            },
            resourceColumns: [
                {
                    group: true,
                    labelText: '日期',
                    field: 'date',
                    width: '50%'
                },
                {
                    labelText: '模拟机号',
                    field: 'machineNO',
                    width: '50%'
                }
            ],
            resources: Dateobj.resourcesList,
            events: Dateobj.eventsList,
            /*事件挂载到dom之前的拦截编辑*/
            eventRender: eventRenderfun,
            eventAfterAllRender: eventAfterRenderFun //所有事件渲染完成
        };
        //初始化排班表
        $('#calendar').fullCalendar(calendarOpt);
        //工具栏插入到日历
        $('#calendar .fc-header-toolbar .fc-left').append($('.calendar-tool'));
        /*时间选择器初始化*/
        dateTimePickerInit();
        initMachineDatePicker(); //初始化模拟机的日期选择器
        //按钮事件绑定
        dataPackage();
        /*自定义表格头*/
        diyTableHeader(classOpt);


    });

    /**
     * @desc 返回生成排课表需要的resources Array,以及events Array
     * @param classList {Array} 从后来传来的数据数组
     * @return {Object} 包含resources Array,以及events Array
     */
    function generateResourceArray(classList) {
        var resourcesList = []; //resource数组， return用
        var eventsList = []; //event数组， return用
        var resCount = 0; //用来生成resource的ID
        var eventCount = 0; //用来生成event的ID
        classList.forEach(function (classListByDate, indexByDate, thisArrayClassList) {
            //classListByDateByMac 每天 数台模拟机里的课程列表
            /*每一天里，按不同的模拟机遍历*/
            classListByDate.dayClass.forEach(function (classListByDateByMac, indexDateByMac, thisArrayByDateByMac) {
                //classListByDateByMac 每天 每一台模拟机里的课程列表
                resCount++;
                var resourceObj = {};
                resourceObj.id = resCount;
                resourceObj.date = classListByDate.date;
                resourceObj.machineNO = classListByDateByMac.machineNO;
                if (resCount%2==0) {
                    resourceObj.eventColor = displayOpt.resourceColor_1;
                } else {
                    resourceObj.eventColor = displayOpt.resourceColor_2;
                }
                resourcesList.push(resourceObj);
                //遍历每一天里每一台模拟机里的每一节课
                classListByDateByMac.clas.forEach(function (classFinal, indexFinal, thisArrayFinal) {
                    eventCount++;
                    var eventObj = {};
                    /*用时间戳做ID*/
                    eventObj.id = parseInt(moment().format('x')) + eventsList.length;
                    eventObj.resourceId = resCount; //课程对应的模拟机ID
                    eventObj.isDiyClassTime = classFinal.isDiyClassTime;
                    /*课程时间设置*/
                    var startEndTimeObj = turnOrderToDisplayTime(classFinal.classOrder, classFinal.classDuration);
                    //turnDisplayTimeToOrder(startEndTimeObj.start, startEndTimeObj.end);
                    eventObj.start = startEndTimeObj.start; //课程开始时间
                    eventObj.end = startEndTimeObj.end; //课程结束时间
                    eventObj.students = classFinal.students; //课程的学生
                    eventObj.teachers = classFinal.teachers; //课程的老师
                    eventObj.inspectors = classFinal.inspectors; //课程的检查员
                    eventObj.log = classFinal.log; //课程的log
                    //如果自定义了时间
                    if (classFinal.isDiyClassTime) {
                        eventObj.diyTimeStart = classFinal.diyTimeStart; //课程的自定义开始时间
                        eventObj.diyTimeEnd = classFinal.diyTimeEnd; //课程的自定义结束时间
                    }
                    eventsList.push(eventObj);
                });
            });
        });
        console.log(eventsList);
        return {
            resourcesList: resourcesList,
            eventsList: eventsList
        };
    }
    /**
     * @desc 创建一个eventResource
     * @params 自建event对象
     * @return 返回一个规定格式的event数组
     * */
    function generateEventResource(eventObj) {
        var eventArray = [eventObj];
        return eventArray;
    }
    /**
     * @通过id返回map,数组需要满足对象的键要求
     * @param array {Array}
     *
     * */
    function getArrayMapById(array) {
        var obj = {};
        array.forEach(function (item, index, thisArray) {
            obj[item.id] = index;
        });
        return obj;
    }

    /**
     * @desc 事件挂载到日历dom之前的拦截编辑
     * @params event $element view
     * */
    function eventRenderfun (event, $element, view) {
/*        console.log('event.id', event.id);
        console.log('eventsList',eventsList);
        console.log('eventDragFromExternal',eventDragFromExternal);*/
        //如果是从模板拖拽进来的需要做额外处理，把模板数组里的事件，加入到事件数组中，并重新生成模板的id
        if (eventDragFromExternal[event.id]) {
            console.log(event);
            var thisTpl = tplList[tplListMap[event.id]];
            console.log(tplListMap, event.id);
            var eventsListItem = {
                id: thisTpl.id,
                resourceId: parseInt(event.resourceId), //对应哪一个resource
                start: moment(event.start.format()).format(),
                end: moment(event.end.format()).format(),
                title: event.title,
                log: thisTpl.log,
                students: cloneObj(thisTpl.students),
                teachers: cloneObj(thisTpl.teachers),
                inspectors: cloneObj(thisTpl.inspectors)
            };
            addEventToEventsList(eventsListItem);
            //重置模板的ID
            thisTpl.id = parseInt(moment().format('x')) + tplList.length; //用时间戳作为ID
            tplListMap = getArrayMapById(tplList);//重新生成map
            eventDragFromExternal[event.id] = false; //当前已经拖拽成功的外部事件拖拽标记为false
            eventDragFromExternal[thisTpl.id] = true; //下一个外部事件拖拽标记为true
        }
        /*复制显示模板*/
        var $tpl = $("#template>.box-wrap").clone();
        $tpl.data().id = event.id; // .box-wrap dom上加了个data属性。
        var thisClassEvent = eventsList[eventsListMap[event.id]]; //当前正在处理的课程
        //插入学员
        thisClassEvent.students.forEach(function (student, index, studentsArray) {
            var $student = $('<span class="card-item student-item person"> </span>');
            $student.text(student.name);
            $student.data().pCode = student.pCode;
            $student.data().userRole = 'students';
            $tpl.find('.student').append($student);
        });
        //插入老师
        thisClassEvent.teachers.forEach(function (teacher, index, teachersArray) {
            var $teacher = $('<span class="card-item teacher-item person"> </span>');
            $teacher.text(teacher.name);
            $teacher.data().pCode = teacher.pCode;
            $teacher.data().userRole = 'teachers';
            $tpl.find('.teacher').append($teacher);
        });
        //插入检查员
        thisClassEvent.inspectors.forEach(function (inspector, index, inspectorsArray) {
            var $inspector = $('<span class="card-item inspector-item person"> </span>');
            $inspector.text(inspector.name);
            $inspector.data().pCode = inspector.pCode;
            $inspector.data().userRole = 'inspectors';
            if (index==0) {
                //todo 第一个inspector加更多左margin
                $inspector.css('margin-left', '8px');
            }
            $tpl.find('.inspector').append($inspector);
        });
        //插入id
/*        var $id = $('<span class="id"> </span>');
        $id.text(event.id);
        $tpl.find('.log').append($id);*/
        //插入log
        var $log = $('<span class=""> </span>');
        $log.text(event.id + thisClassEvent.log);
        $tpl.find('.log').append($log);
        //如果自定义了时间，插入时间标记 isDiyClassTime=0 or 1
        if (thisClassEvent.isDiyClassTime) {
            var $timeNotice = $('<i class="fa fa-exclamation time-notice" aria-hidden="true"></i>');
        }
        //剔除fullcalendar默认的显示元素
        $element.find(".fc-content>span.fc-title").remove();
        //完成渲染元素的编辑,挂在最终结果
        $element.find(".fc-content").append($tpl);
        $element.find(".fc-content").append($timeNotice);
    }
    /**
     * @desc 所有的事件在日历上渲染完成
     */
    function eventAfterRenderFun(view) {
        //由于重新渲染了事件，所以需要重新绑定人名点击事件
        if($('.toggleClickModeButton').hasClass('orange-theme active')) {
            if (!$._data($('#calendar .card-item.person')[0],'events')) {
                console.log('重新绑定');
                bindNameClickDel(); //绑定人名点击事件
            }
        }
        /*事件的高度对齐*/
        $('#calendar .fc-timeline-event.fc-event').each(function (index) {
            //console.log($(this).height())
        })
    }
    /**
     * @desc 打开layer新建框 新建事件
     * @params start 开始事件 end 结束时间 resource 对应的resource
     */
    function openCreateLayer (start, end, resource) {
        layer.open({
            title: '新建课程',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['550px',''],
            btn:["保存","取消"],
            success:function($layDom){
                //重置表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
            },
            yes: function(index, $layDom){
                //生成事件对象
                var eventData = {
                    id: parseInt(moment().format('x')) + eventsList.length, //用时间戳作为ID
                    resourceId: resource.id,
                    start: start,
                    end: end
                };
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');

                //向统一的事件库加入事件资源
                var eventsListItem = {
                    id: eventData.id,
                    resourceId: parseInt(resource.id), //对应哪一个resource
                    start: moment(start.format()).format(), //日历上需要用的时间
                    end: moment(end.format()).format(),
                    title: 'title',
                    log: $layDom.find('#input-log').val(),
                    students: students,
                    teachers: teachers,
                    inspectors: inspectors
                };
                //是否diyTime，并设置自定义时间
                if ($('#is-diy-time').prop('checked')) {
                    eventsListItem.isDiyClassTime = 1;

                    eventsListItem.diyTimeStart =  $layDom.find('#class-time-start input').val();
                    eventsListItem.diyTimeEnd =  $layDom.find('#class-time-end input').val();
                } else {
                    eventsListItem.isDiyClassTime = 0;
                }
                eventsList.push(eventsListItem); //像资源库push新事件
                eventsListMap = getArrayMapById(eventsList);//重新生成map
                //console.log(eventsListItem);
                //console.log($('#select-students').select2('data'));
                //在日历上添加事件
                $('#calendar').fullCalendar( 'renderEvent', eventData , 'stick');
                $('#calendar').fullCalendar('unselect');
                layer.close(layer.index);
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
            }
        });
    }
    /**
     * @desc 打开layer编辑框，编辑事件
     * @params
     */
    function openEditLayer (event, element) {
        layer.open({
            title: '编辑课程',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['550px',''],
            btn:["保存", "删除", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                /*填充已经存在的人员*/
                /*格式化select2选出的人员的val*/
                var studentsVal = $.map(eventsList[eventsListMap[event.id]].students, function (obj) {
                    return obj.pCode;
                });
                var teachersVal = $.map(eventsList[eventsListMap[event.id]].teachers, function (obj) {
                    return obj.pCode;
                });
                var inspectorsVal = $.map(eventsList[eventsListMap[event.id]].inspectors, function (obj) {
                    return obj.pCode;
                });
                $('#select-students').val(studentsVal).trigger('change');
                $('#select-teachers').val(teachersVal).trigger('change');
                $('#select-inspectors').val(inspectorsVal).trigger('change');
                $layDom.find('#input-log').val(eventsList[eventsListMap[event.id]].log);
                /*填充自定义时间*/
                if (eventsList[eventsListMap[event.id]].isDiyClassTime == 1) {
                    $('#is-diy-time').prop('checked', true).trigger('change');
                    $layDom.find('#class-time-start input').val(eventsList[eventsListMap[event.id]].diyTimeStart);
                    $layDom.find('#class-time-end input').val(eventsList[eventsListMap[event.id]].diyTimeEnd);
                } else {
                    $('#is-diy-time').prop('checked', false);
                }
            },
            yes: function(index, $layDom){
                //生成事件对象
                var eventData = {
                    id: event.id, //用时间戳作为ID
                    resourceId: event.resourceId,
                    start: event.start,
                    end: event.end
                };
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');
                //向统一的事件库加入事件资源
                var eventsListItem = {
                    id: eventData.id,
                    resourceId: parseInt(eventData.resourceId), //对应哪一个resource
                    start: event.start.format(),
                    end: event.end.format(),
                    title: 'title',
                    log: $layDom.find('#input-log').val(),
                    students: students,
                    teachers: teachers,
                    inspectors: inspectors
                };
                //是否diyTime，并设置自定义时间
                if ($('#is-diy-time').prop('checked')) {
                    eventsListItem.isDiyClassTime = 1;
                    eventsListItem.diyTimeStart =  $layDom.find('#class-time-start input').val();
                    eventsListItem.diyTimeEnd =  $layDom.find('#class-time-end input').val();
                } else {
                    eventsListItem.isDiyClassTime = 0;
                }
                eventsList[eventsListMap[event.id]] = eventsListItem; //替换修改的事件
                eventsListMap = getArrayMapById(eventsList);//重新生成map
                //删除事件
                $('#calendar').fullCalendar( 'removeEvents', event.id); /*根据id删除事件*/
                //添加事件
                $('#calendar').fullCalendar( 'renderEvent', eventData , 'stick');
                $('#calendar').fullCalendar('unselect');
                layer.close(layer.index);
            },
            /*删除按钮*/
            btn2: function (index, $layDom) {
                $('#calendar').fullCalendar( 'removeEvents', event.id); /*根据id删除事件*/
                eventsList.splice(eventsListMap[event.id], 1); //删除事件
                eventsListMap = getArrayMapById(eventsList); //重新生成map
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
            }
        });
    }
    /**
     * @desc 创建新模板
     * */
    function openLayerCreateTpl () {
        layer.open({
            title: '新建模板',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['550px',''],
            btn:["保存", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                hideInTpl(); //隐藏自定义时间选项
            },
            yes: function(index, $layDom){
                //tplList
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');
                //向模板库加入模板资源，此时定义id
                var TplListItem = {
                    id: parseInt(moment().format('x')) + tplList.length, //用时间戳作为ID
                    title: 'title',
                    log: $layDom.find('#input-log').val(),
                    students: students,
                    teachers: teachers,
                    inspectors: inspectors
                    //isDragFromExternal: true是否是外部的拖拽事件
                };
                tplList.splice(tplList.length,0,TplListItem); //添加模板元素
                tplListMap = getArrayMapById(tplList);//重新生成map
                eventDragFromExternal[TplListItem.id] = true; //是否是外部拖拽事件
                layer.close(layer.index);
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                showInTpl(); //显示自定义时间选项
            }
        });
    }
    /**
     * @desc 编辑模板
     *
     * */
    function openLayerEditTpl(item) {
        console.log(item);
        layer.open({
            title: '编辑模板',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['550px',''],
            btn:["保存", "删除", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                hideInTpl(); //隐藏自定义时间选项
                /*填充已经存在的人员*/
                /*格式化select2选出的人员的val*/
                var thisTpl = tplList[tplListMap[event.id]];
                var studentsVal = $.map(item.students, function (obj) {
                    return obj.pCode;
                });
                var teachersVal = $.map(item.teachers, function (obj) {
                    return obj.pCode;
                });
                var inspectorsVal = $.map(item.inspectors, function (obj) {
                    return obj.pCode;
                });
                $('#select-students').val(studentsVal).trigger('change');
                $('#select-teachers').val(teachersVal).trigger('change');
                $('#select-inspectors').val(inspectorsVal).trigger('change');
                $layDom.find('#input-log').val(item.log);
            },
            yes: function(index, $layDom){
                //tplList
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');
                //修改模板库的模板
                item.log = $layDom.find('#input-log').val();
                item.students = students;
                item.teachers = teachers;
                item.inspectors = inspectors;
                layer.close(layer.index);
            },
            /*删除按钮*/
            btn2: function (index, $layDom) {
                console.log(tplListMap[item.id]);
                tplList.splice(tplListMap[item.id], 1); //删除tpl
                tplListMap = getArrayMapById(tplList);//重新生成tpl map
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                showInTpl(); //显示自定义时间选项
            }
        });
    }
    /**
     * @desc 创建新模拟机
     * */
    function openLayerCreateMachine () {
        layer.open({
            title: '新建模拟机',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['550px',''],
            btn:["保存", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-machine-name']);
                //限制日期到当前月份
                $('#create-machine-date').datetimepicker('setStartDate', globalVar.currentMonthStart);
                $('#create-machine-date').datetimepicker('setEndDate', globalVar.currentMonthEnd);
            },
            yes: function(index, $layDom){
                var date = $('#create-machine-date').val();
                var name = $('#create-machine-name').val();
                addMachine(date, name);
                layer.close(layer.index);
            },
            content: $("#layer-body-1"),
            end: function () {
                //重置select2、以及表单
                resetSelect2(['#select-machine-name']);
            }
        });
    }
    /**
     * @desc 删除模拟机
     **/
    function openLayerDeleteMachine () {
        layer.open({
            title: '删除模拟机',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['550px',''],
            btn:["删除", "取消"],
            success:function($layDom){
                /*初始化模拟机选择器*/
                var machineOpt = $.map(Dateobj.resourcesList, function (item, index) {
                    return {
                        id: item.id,
                        text: item.machineNO
                    }
                });
                $('#select-machine-name').empty().select2({
                    placeholder: '选择模拟机',
                    data: machineOpt,
                    multiple: true,
                    width: '100%'
                });
                //重置select2、以及表单
                resetSelect2(['#select-machine-name']);
                //限制日期到当前月份
                $('#select-machine-date').datetimepicker('setStartDate', globalVar.currentMonthStart);
                $('#select-machine-date').datetimepicker('setEndDate', globalVar.currentMonthEnd);
            },
            yes: function(index, $layDom){

                layer.close(layer.index);
            },
            content: $("#layer-body-2"),
            end: function () {
                //重置select2
                resetSelect2(['#select-machine-name']);
            }
        });
    }
    /**
     * @desc 向统一的事件库加入事件资源
     * @param eventGeneObj {Object} 包含所有必须事件信息的对象
     */
    function addEventToEventsList (eventGeneObj) {
        eventsList.push(eventGeneObj);
        eventsListMap = getArrayMapById(eventsList);//重新生成map
        tplListMap = getArrayMapById(tplList);
    }


    /**
     * @desc 课程时间的转化，把classOrder、classDuration转换成插件可以识别的时间，从而渲染
     * @param classOrder 课程开始的节数
     * @param classDuration 课程持续的节数
     * @returns {{start: string, end: string}}
     * 均是通过moment转化的带+08:00的时间字符串，日历插件渲染用
     */
    function turnOrderToDisplayTime (classOrder, classDuration) {
        var start = moment.duration(timeLineOpt.minTime);
        var end = moment.duration(timeLineOpt.minTime);
        for ( var i =1; i < classOrder; i++){
            start.add(moment.duration(timeLineOpt.slotDuration));
            end.add(moment.duration(timeLineOpt.slotDuration));
        }
        end.add(moment.duration(classDuration));
        //注意 add方法是直接在对象上操作，会改变对象，而不是返回值
        var baseTimeStart = moment(thisDate + 'T00:00:00+08:00');
        var baseTimeEnd = moment(thisDate + 'T00:00:00+08:00');
        return {
            start: baseTimeStart.add(start).toJSON(), //课程开始时间,
            end: baseTimeEnd.add(end).toJSON() //课程结束时间
        }
    }
    /**
     * @desc 通过日历插件中的起始时间，计算课程的 classOrder, classDuration
     * @param start {String} 可以转换成+08:00时间对象的时间字符串
     * @param end {String} 可以转换成+08:00时间对象的时间字符串
     * @return {{classOrder: int, classDuration: int}}
     */
    function turnDisplayTimeToOrder(start, end) {
        var classOrder = 1;
        var classDurationTimes = 0; //是slotDuration的多少倍
        var classDuration = {hours: 0, minutes: 0};
        var minDuration = moment.duration(timeLineOpt.slotDuration);
        //从最初时间到课程开始的duration
        //计算classOrder
        var startDuration =  moment.duration(moment(start).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        var endDuration =  moment.duration(moment(end).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        //console.log(moment.duration(startDuration).asSeconds(),minDuration.asSeconds());
        while (startDuration.asSeconds() != 0) {
            classOrder++;
            startDuration.subtract(minDuration);
        }
        //计算classDuration
        startDuration =  moment.duration(moment(start).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        endDuration =  moment.duration(moment(end).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        endDuration.subtract(startDuration);
        while (endDuration.asSeconds() != 0) {
            classDurationTimes++;
            endDuration.subtract(minDuration);
        }
        for (var i = 0;i < classDurationTimes;i++){
            classDuration.hours += timeLineOpt.slotDuration.hours;
            classDuration.minutes += timeLineOpt.slotDuration.minutes;
        }
        //console.log(classOrder, classDuration, classDurationTimes);
        return{
            classOrder: classOrder,
            classDuration: classDuration
        }
    }
    /**
     * @desc 在eventsList中改变drag或者resize事件的时间参数 以及resouceid
     * @param event
     * @return {{classOrder: int, classDuration: Object}}
     */
    function changeEventByDrag (event) {
        eventsList[eventsListMap[event.id]].start = event.start.format();
        eventsList[eventsListMap[event.id]].end = event.end.format();
        eventsList[eventsListMap[event.id]].resourceId = parseInt(event.resourceId);
        return turnDisplayTimeToOrder(moment(event.start.format()).format(), moment(event.end.format()).format());
    }
    /**
     * @desc 清理特定的select2的val 以及layer里的表单
     * @param array {Array} 包含需要清理的select2选择器的数组
     */
    function resetSelect2 (array) {
        array.forEach(function (selector, index, array) {
            $(selector).val(null).trigger('change');
        });
        $('#layer-body > form')[0].reset();
        $('#layer-body-1 > form')[0].reset();
        $('#is-diy-time').prop('checked', false);
        $('#is-diy-time').trigger('change');
    }
    /**
     * @desc 把select2选出的项格式化 返回一个新的对象
     * @param selector {String} jquery id选择器
     * @returns {Array}
     */
    function formatSelect2Result(selector) {
        return $.map($(selector).select2('data'), function (obj) {
            return {
                name: obj.text,
                pCode: obj.id
            }
        });
    }
    /**
     * @desc 对象复制
     */
    function cloneObj(oldObj) {
        return JSON.parse(JSON.stringify(oldObj))
    }
    /**
     * @desc 隐藏自定义事件选项
     */
    function hideInTpl() {
        $('#diy-time-control').hide();
        $('#diy-time-wrap').hide();
    }
    /**
     * @desc 显示自定义事件选项
     */
    function showInTpl() {
        $('#diy-time-control').show();
        $('#diy-time-wrap').show();
    }
    /**
     * @desc 绑定人名点击事件
     *
     */
    function bindNameClickDel() {
        /*绑定人名的点击事件*/
        $('#calendar .card-item.person').on('click.deleteEvent',function (event) {
            console.log('eventclick事件触发');
            var clickedNameDom = this;
            editNameFromEvent(clickedNameDom); //从事件中删除点击的人
            return false;
        });
    }
    /**
     * @desc 解绑人名点击事件
     *
     */
    function unbindNameClickDel() {
        /*解绑人名的点击事件*/
        $('#calendar .card-item.person').off('click.deleteEvent');
    }
    /**
     * @desc 切换人名点击删除模式
     * @param event
     */
    function toggleClickModeEvent (event) {
        //第一次点击、赋值为1，表示按钮状态激活
        $(this).data().toogleStatus = $(this).data().toogleStatus ?
            $(this).data().toogleStatus : 1 ;
        if ($(this).data().toogleStatus == 1) {
            $(this).addClass('orange-theme active toggleClickModeButton');
            $(this).text('快速删除模式已激活！');
            $(this).data().toogleStatus = -1;
            bindNameClickDel(); //绑定人名点击事件

        } else {
            $(this).removeClass('orange-theme active');
            $(this).text('快速删除模式已关闭');
            $(this).data().toogleStatus = 1;
            unbindNameClickDel();  //解绑人名点击事件
        }
    }
    /**
     * @desc 通过点击人名 从事件中删除该成员
     * @param dom {Object} 点击的dom
     */
    function editNameFromEvent(dom) {
        var userRole = $(dom).data().userRole; //要修改人的身份
        var pCode = $(dom).data().pCode; //要修改人的工号
        var eventId = $(dom).parents().eq(1).data().id; //获得事件id
        var matesList = eventsList[eventsListMap[eventId]][userRole]; //一起搬砖的工友数组
        matesList.forEach(function (person, index, thisArray) {
            if (person.pCode == pCode) {
                thisArray.splice(index, 1); //删除对应的人
            }
        });
        //删除成功、刷新日历
        $('#calendar').fullCalendar( 'rerenderEvents' );
    }
    /**
     * @desc 数据打包
     *
     */
    function dataPackage() {
        $('#data-package').on('click',function (event) {
            console.log('eventsList', eventsList);
            console.log('eventsListMap', eventsListMap);
            console.log('tplList', tplList);
            console.log('tplListMap', tplListMap);
        });
    }
    /**
     * @desc 鼠标移入事件时的回调函数
     * @param event
     * @param jsEvent
     * @param view
     */
    function eventMouseoverFun (event, jsEvent, view) {
        /*用于判断备注是否有省略*/
        var wrapWidth = $(jsEvent.currentTarget).find('.item-wrap.log').innerWidth();
        var spanWidth = $(jsEvent.currentTarget).find('.item-wrap.log>span').innerWidth();
        var thisEvent = eventsList[eventsListMap[event.id]]; //从事件列表中取出当前事件
        var timeInfo = ''; //自定义时间
        var logInfo = '';
        /*如果 没有省略 而且 没有自定义时间*/
        if (spanWidth < wrapWidth && !parseInt(thisEvent.isDiyClassTime)) {
            return false;
        }
        //无自定义时间时不显示时间信息
        if (parseInt(thisEvent.isDiyClassTime)) {
            var s = thisEvent.diyTimeStart;
            var e = thisEvent.diyTimeEnd;
            timeInfo = '自定义时间：' + s + '-' + e + '<br>';
        }
        //log没有过长隐藏，不显示log
        if (spanWidth >= wrapWidth) {
            logInfo = '备注：' + thisEvent.log;
        }
        layerTipIndex = layer.tips(timeInfo  + logInfo, jsEvent.currentTarget, {
            tips: [1,'white'],
            time: 0,
            skin: 'white-tip',
            area: ['200px']
        });
        //console.log(event.id + 'in' + layerTipIndex);
    }
    /**
     * @desc 鼠标移除事件时的回调函数
     * @param event
     * @param jsEvent
     * @param view
     */
    function eventMouseoutFun (event, jsEvent, view) {
        var wrapWidth = $(jsEvent.currentTarget).find('.item-wrap.log').innerWidth();
        var spanWidth = $(jsEvent.currentTarget).find('.item-wrap.log>span').innerWidth();
        var thisEvent = eventsList[eventsListMap[event.id]]; //从事件列表中取出当前事件
        /*如果 没有省略 而且 没有自定义时间*/
        if (spanWidth < wrapWidth && !parseInt(thisEvent.isDiyClassTime)) {
            return false;
        }
        layer.close(layerTipIndex);
    }
    /**
     * @desc 激活时间选择器
     *
     */
    function dateTimePickerInit () {
        //var diy
        $('#class-time-start').clockpicker({
            autoclose: 1
        });
        $('#class-time-end').clockpicker({
            autoclose: 1
        });

        //日期选择器初始化
        $("#class-table-date-picker").datetimepicker({
            startView: 3,
            minView: 3,
            language: 'zh-CN',
            format: 'yyyy-mm',
            autoclose: true,
            todayBtn: true,
            todayHighlight: true,
            pickerPosition: "bottom-right"
        }).on('changeDate', function (ev) {
            var date = $("#class-table-date-picker").val();
            globalVar.currentDate = date;  //格式2017-09
            /*获取当月的第一天和最后一天*/
            var startEndDateObj = getStartAndEndDateOfMonth(globalVar.currentDate);
            /*限制模拟机时间选择器的时间范围*/
            globalVar.currentMonthStart = startEndDateObj.start;
            globalVar.currentMonthEnd = startEndDateObj.end;
            //todo: 初始化日历方法还没写
            initCalendar(date);
        });
        //初始化显示今天
        $("#class-table-date-picker").datetimepicker("setDate", new Date()).trigger('changeDate');
        //上一天、下一天按钮事件绑定
        $('#next-date-btn').on('click', function () {
            var dateObj = moment($("#class-table-date-picker").val());
            //加一天
            dateObj.add(1, 'day');
            $("#class-table-date-picker").datetimepicker("setDate", new Date(dateObj.format()) ).trigger('changeDate');
        });
        $('#prev-date-btn').on('click', function () {
            var dateObj = moment($("#class-table-date-picker").val());
            //减一天
            dateObj.subtract(1, 'day');
            $("#class-table-date-picker").datetimepicker("setDate", new Date(dateObj.format()) ).trigger('changeDate');
        });
    }
    /**
     * @desc 初始化模拟机的日期选择
     **/
    function initMachineDatePicker () {
        /*创建模拟机的日期选择器*/
        $('#create-machine-date').datetimepicker({
            startView: 2,
            minView: 2,
            language: 'zh-CN',
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true,
            pickerPosition: "bottom-right"
        });
        /*删除模拟机的日期选择器*/
        $('#select-machine-date').datetimepicker({
            startView: 2,
            minView: 2,
            language: 'zh-CN',
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true,
            pickerPosition: "bottom-right"
        });
    }
    /**
     * @desc 获取当月的第一天和最后一天
     * @param DateString {String} 例如 2017-09
     * @return
     **/
    function getStartAndEndDateOfMonth (DateString) {
        var currentDate = new moment(DateString);
        return {
            start: currentDate.startOf('month').format('YYYY-MM-DD'),
            end: currentDate.endOf('month').format('YYYY-MM-DD')
        }
    }
    /**
     * @desc 自定义排班表的表头，并删除原来的
     * */
    function diyTableHeader(classOpt) {
        $('.fc-chrono .fc-widget-header').each(function (index) {
            $(this).find('.fc-cell-text').text(classOpt.classArrange[index].time);
            var $dom = $('<div class="fc-cell-content border-bottom"></div>');
            $dom.text(classOpt.classArrange[index].name);
            $(this).prepend($dom);
        });
        //自定义表头结束后，激活resize事件，使表头对其
        $(window).trigger('resize');
    }
    /**
     * @desc 根据传入的事件，重新加载一定数量天数的排班表
     * @param date
     */
    function initCalendar (date) {
        console.log('重新加载排班表');
    }
    /**
     * @desc 更新eventsList中的课程order信息
     * @param orderObj {Object}
     * @param eventId {int}
     */
/*    function changeeventOrder(orderObj, eventId) {
        console.log(orderObj, eventId);
        var thisClass = eventsList[eventsListMap[event.id]]; //拿到当前课程在eventsList中的引用
    }*/

    /**
     * @desc 添加模拟机编号
     * @param date {String} 格式 2017-09-01
     * @param name {String}
     */
    function addMachine (date, name) {
        var resourcesList = Dateobj.resourcesList; //获取资源列表的引用
        var newMachineObj = {
            id: resourcesList.length + 1,
            date: date,
            machineNO: name,
            eventColor: "#3b91ad"
        };
        resourcesList.push(newMachineObj);
        $('#calendar').fullCalendar( 'refetchResources' ); //重新加载资源
    }
</script>
</body>
</html>