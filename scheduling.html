<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>模拟机排班</title>
    <link rel='stylesheet' href='resource/lib/bootstrap/dist/css/bootstrap.css'/>
    <link rel='stylesheet' href='resource/lib/fullcalendar/dist/fullcalendar.css'/>
    <link rel='stylesheet' href='resource/lib/fullcalendar-scheduler/dist/scheduler.css'/>
    <link rel='stylesheet' href='resource/css/custom-style/base-css.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/style.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/base.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/animate.css'/>
    <link rel='stylesheet' href='resource/lib/hplus/css/font-awesome.min.css'/>
    <link rel='stylesheet' href='resource/lib/layer/skin/layer.css'/>
    <link rel='stylesheet' href='resource/lib/select2/css/select2.min.css'/>
    <link rel='stylesheet' href='resource/lib/select2/css/select2-bootstrap.min.css'/>
    <style>
        #calendar {
            width: 100%;

        }
        #tpl-wrap {
            margin: auto;
        }
/*        #calendar .fc-timeline-event {
            height: 100%;
            min-height: 200px;
        }*/

        .no-padding {
            padding: 0;
        }

        .no-margin {
            margin: 0;
        }

        .item-wrap > .card-item {
            background-color: #9d9d9d;
            padding: 2px 2px;
            margin: 2px 2px;
        }

        .box-wrap > div {
            text-align: center;

        }

        /*除了最后一个，加点线*/
        .box-wrap > div:not(.class-desc) {
            margin-bottom: 5px;
            border-bottom: 1px #ddd dashed;
            padding-bottom: 5px;
        }

        /*时间块里面文字自动换行*/
        .fc-timeline-event .fc-content {
            white-space: normal;
            line-height: 2;

        }

        /*人名不分行*/
        .fc-timeline-event .fc-content span.card-item {
            /*word-break: keep-all;*/
        }

        #delete-box,#test-box {
            height: 200px;
            background-color: #9d9d9d;
            line-height: 200px;
            text-align: center
        }
        .ui-state-highlight{
            background-color: #1b6d85;
        }
        .ui-state-hover{
            background-color: red;
        }
        .ui-state-active{
            background-color: orange;
        }
        .fc-chrono .fc-cell-content.border-bottom {
            border-bottom: 1px solid #ddd;
        }
        .fc-ltr .fc-time-area .fc-chrono th {
            text-align: center;
        }
        .margin-top {
            margin-top: 50px;
        }
        .tpl-hide {
            display: none;
        }
    </style>
</head>
<body class="gray-bg">
<div class="container">
    <div class="margin-top"></div>
    <div class="row">
        <!--模板放置区-->
        <div class="col-xs-2" >
            <!--vue control-->
            <div class="ibox float-e-margins" id="tpl-wrap">
                <div class="ibox-title ibox-title-blue">
                    <h5><i class="fa fa-pencil"></i>&nbsp;排课模板</h5>
                </div>
                <div class="ibox-content">
                    <div class="btn-group" id="table0-toolbar" role="group">
                        <button
                        @click="vOpenLayerCreateTpl"
                        type="button"
                        class="btn btn-outline btn-default btn-add"
                        data-toggle="tooltip"
                        title="添加">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn btn-outline btn-default btn-edit" data-toggle="tooltip"
                                title="修改">
                            <i class="fa fa-edit" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn btn-outline btn-default btn-delete" data-toggle="tooltip"
                                title="删除">
                            <i class="fa fa-trash" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn btn-outline btn-default btn-refresh" data-toggle="tooltip"
                                title="刷新">
                            <i class="fa fa-refresh" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="ui-widget-content external-event-box" >
                        <class-tpl
                        @click.native="openLayerEditTpl(item)"
                        v-for="(item, index) in tplList"
                        :tpl="item"
                        :key="index"></class-tpl>
                    </div>
                </div>
            </div>
        </div>
        <!--排班表放置区-->
        <div class="col-xs-10">
            <div class="ibox float-e-margins">
                <div class="ibox-title ibox-title-blue">
                    <h5><i class="fa fa-pencil"></i>&nbsp;排班表</h5>
                </div>
                <div class="ibox-content">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--layer弹窗，新建、编辑排班事件-->
<div class="wrapper wrapper-content layer-body" id="layer-body" style="display:none;">
    <form class="form-horizontal" id="">
        <div class="form-group">
            <label class="col-sm-4 control-label">学员<font color='red'>*</font>:
            </label>
            <div class="col-sm-6">
                <select id="select-students"></select>
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-4 control-label">教员</label>
            <div class="text-left col-sm-6">
                <select id="select-teachers"></select>
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-4 control-label">检查员</label>
            <div class="text-left col-sm-6">
                <select id="select-inspectors"></select>
            </div>
        </div>
        <div class="form-group">
            <label  class="col-sm-4 control-label">备注</label>
            <div class="text-left col-sm-6">
                <textarea class="form-control" id="input-log" rows="3"></textarea>
            </div>
        </div>
        <div class="form-group" id="diy-time-control">
            <div class="text-left col-sm-6 col-sm-offset-4">
                <label>
                    <input type="checkbox" id="is-diy-time">自定义课程时间
                </label>
            </div>
        </div>
        <div class="form-group" id="diy-time-wrap" style="display: none">
            <label  class="col-sm-4 control-label">自定义课程时间</label>
            <div class="text-left col-sm-6">
                <input type="text"  id="class-time-start" name="class-time-start" class="form-control" />-
                <input type="text"  id="class-time-end" name="class-time-end" class="form-control" />
            </div>
        </div>
    </form>
</div>


<!--模板区，复制用-->
<div id="template" style="display: none">
    <div class="box-wrap ">
        <div class="no-margin item-wrap student">

        </div>
        <div class="row no-margin item-wrap teacher inspector">

        </div>
        <div class="class-desc item-wrap log">

        </div>
    </div>
</div>
<script src='resource/lib/jquery/dist/jquery.js'></script>
<script src='resource/lib/vue.js'></script>
<script src='resource/lib/jquery-ui-1.12.1/jquery-ui.min.js'></script>
<script src='resource/lib/bootstrap/dist/js/bootstrap.js'></script>
<script src='resource/lib/moment/min/moment.min.js'></script>
<script src='resource/lib/fullcalendar/dist/fullcalendar.js'></script>
<script src='resource/lib/fullcalendar-scheduler/dist/scheduler.js'></script>
<script src='resource/lib/layer/layer.js'></script>
<script src='resource/lib/select2/js/select2.min.js'></script>
<script type="x-template" id="class-tpl">
        <div class="fc-content fc-event" v-bindDrag="tpl">
            <div class="box-wrap ">
                <div class="no-margin item-wrap student">
                    <span class="card-item" v-for="(item, index) in tpl.students" :key="index">{{item.name}}</span>
                </div>
                <div class="row no-margin item-wrap teacher inspector">
                    <span class="card-item" v-for="(item, index) in tpl.teachers" :key="index">{{item.name}}</span>
                    <span class="card-item" v-for="(item, index) in tpl.inspectors" :key="index">{{item.name}}</span>
                </div>
                <div class="class-desc item-wrap log">
                    <span>{{tpl.log}}</span>
                </div>
            </div>
        </div>
</script>
<script>
    $.fn.select2.defaults.set( "theme", "bootstrap" ); //使用select2-bootstrap主题
    moment.fn.toJSON = function() { return this.format()}; //处理时区的问题
    //事件模板
    var classTpl = {
        props:{
            tpl: {
                type: Object,
                required: true,
                default: {
                    id: '1'
                }
            }
        },
        template:'#class-tpl',
        methods:{
        },
        directives: {
            bindDrag: {
                /*插入时绑定拖拽事件*/
                inserted: function (el, binding) {
                    // make the event draggable using jQuery UI
                    $(el).draggable({
                        zIndex: 999,
                        revert: true,      // will cause the event to go back to its
                        revertDuration: 0  //  original position after the drag
                    });
                    // store data so the calendar knows to render an event upon drop
                    $(el).data('event', {
                        isDragFromExternal: true, //是否是外部的拖拽事件
                        title: 'test',
                        id: binding.value.id,
                        //id: Dateobj.eventsList[3].id,
                        duration: '01:00',
                        stick: true // maintain when user navigates (see docs on the renderEvent method)
                    });
                }
            }
        }
    };
    var thisDate = '2017-01-01'; //写死，因为不在日历插件里涉及日期
    var timeLineOpt = {
        minTime: {hours: 0, minutes: 0}, //开始时间
        maxTime: {hours: 8, minutes: 0}, //结束时间
        slotDuration: {hours:1, minutes:0}, //表格内部块，一个块代表几个小时，小课时长
        slotLabelInterval: {hours:2, minutes:0} //标题一个块代表几个小时， 大课时长
    };
    var classOpt = {
        classNum:4, //课时数
        minClassNum: 8,  //每天最多的课时数
        classDuration: '04:00:00', //课时长
        minClassDuration: '02:00:00', //小课时长
        /*一天的课程安排时间*/
        classArrange: [
            {
                name: '第一场',
                time: '08:00-12:00'
            },
            {
                name: '第二场',
                time: '12:15-16:15'
            },
            {
                name: '第三场',
                time: '16:30-20:30'
            },
            {
                name: '第四场',
                time: '20:45-00:45'
            }
        ]
    };
    var classList = []; //模拟的后台数据 事件列表
    var tplList = []; //模板列表
    var tplListMap = {}; //模板列表
    var userList = []; //模拟的人员数据
    /*远程获取数据*/
    $.ajax({
        type: "get",
        async: false,
        url: "mockData/class_list.json",
        dataType: 'json',
        success: function (data) {
            classList = data;
        }
    });
    var Dateobj = generateResourceArray(classList); /*通过远程获取的原始数据生成一个对象,包含event数组以及resource数组*/
    var eventsList = Dateobj.eventsList; //事件列表
    $.ajax({
        type: "get",
        async: false,
        url: "mockData/tpl_list.json",
        dataType: 'json',
        success: function (data) {
            tplList = data;
            tplList.forEach(function (tpl, index, thisArray) {
                tpl.id = parseInt(moment().format('x')) + eventsList.length; //用时间戳作为ID
            }); //给刚加载的模板，设置id
            tplListMap = getArrayMapById(tplList); //生成map
        }
    });
    /*生成模拟的人员数据*/
    $.ajax({
        type: "get",
        async: false,
        url: "mockData/user.json",
        dataType: 'json',
        success: function (data) {
            userList = data;
        }
    });
    var eventsListMap = getArrayMapById(eventsList); /*事件资源数组的map*/
    console.log(Dateobj, eventsListMap);
    var vueCon = new Vue({
        el: '#tpl-wrap',
        components: {
            'class-tpl': classTpl
        },
        data: {
            tplList: tplList
        },
        methods: {
            vOpenLayerCreateTpl: openLayerCreateTpl,
            openLayerEditTpl: openLayerEditTpl
        }
    });
    $(document).ready(function () {
        /*checkbox事件绑定*/
        $('#is-diy-time').on('change', function (e) {
            if ($(this).prop('checked')) {
                $('#diy-time-wrap').show();
            } else {
                $('#diy-time-wrap').hide();
            }
        });
        /*新建选择框初始化*/
        $('#select-students').select2({
            placeholder: '选择学员',
            data:userList,
            multiple: true
        });
        $('#select-teachers').select2({
            placeholder: '选择教员',
            data:userList,
            multiple: true
        });
        $('#select-inspectors').select2({
            placeholder: '选择检查员',
            data:userList,
            multiple: true
        });
        /*生成模板*/
        $(".external-event-box>.fc-event").each(function() {


        });
        //日程表的配置
        var calendarOpt = {
            schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
            now: '2017-01-01', //当前时间
            selectable: true, //是否可以单击选择
            selectHelper: true,
            eventOverlap: false, /*事件之间是否可以重叠*/
            /*空日历选择之后的回调函数*/
            select: function (start, end, jsEvent, view, resource) {
                /*此处的start和end不带+08:00*/
                openCreateLayer(start, end, resource); //打开新建事件的弹窗
            },
            /*事件的点击事件*/
            eventClick: function(event, element) {
                console.log(event);
                openEditLayer(event, element); //打开编辑事件的弹窗
            },
            /*日历内的事件拖拽 改变start和end*/
            eventDrop: function (event, delta, revertFunc, jsEvent, ui, view) {
                console.log(changeEventTime(event));
            },
            /*日历内的事件改变形状 改变start和end*/
            eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                console.log(changeEventTime(event));
            },
            /*外部事件拖拽事件*/
            drop:function (date, jsEvent, ui, resourceId ) {
                console.log(date, jsEvent, ui, resourceId);
                //貌似此时设置id已经晚了
                //$(this).data().event.id = Dateobj.eventsList[3].id;
            },
            /*外部事件被接受事件*/
            eventReceive: function (event) {

            },
            editable: true, //是否可以拖拽编辑duration、起始时间
            droppable: true, //是否可以放置事件
            aspectRatio: 2, //宽高比
            resourceAreaWidth: '20%', /*左侧资源区的宽度*/
            header: {
                left: '',
                center: '',
                right: ''
            },
            defaultView: 'timelineDay', //默认视图
            /*视图设置*/
            views: {
                timelineDay: {
                    type: 'timeline',
                    duration: {days: 1}, //事件线长度 默认1天
                    slotDuration: {hours:1, minutes:0} , //表格内部块，一个块代表几个小时
                    slotLabelFormat: [
                        'kk:mm'  // top level of text*/
                    ], //标题事件显示格式
                    slotLabelInterval: {hours:2, minutes:0}, //标题一个块代表几个小时
                    buttonText: '1DAY',
                    scrollTime: '00:00',
                    minTime: {hours: 0, minutes: 0},
                    maxTime: {hours: 8, minutes: 0}
                }
            },
            resourceColumns: [
                {
                    group: true,
                    labelText: '日期',
                    field: 'date',
                    width: '60%'
                },
                {
                    labelText: '模拟机号',
                    field: 'machineNO',
                    width: '40%'
                }
            ],
            resources: Dateobj.resourcesList,
            events: Dateobj.eventsList,
            /*事件挂载到dom之前的拦截编辑*/
            eventRender: eventRenderfun
        };
        $('#calendar').fullCalendar(calendarOpt);
        /*测试自定义表格头*/
        $('.fc-chrono .fc-widget-header').each(function (index) {
            $(this).find('.fc-cell-text').text(classOpt.classArrange[index].time);
            var $dom = $('<div class="fc-cell-content border-bottom"></div>');
            $dom.text(classOpt.classArrange[index].name);
            $(this).prepend($dom);
        });

    });

    /**
     * @desc 返回生成排课表需要的resources Array,以及events Array
     * @param classList {Array} 从后来传来的数据数组
     * @return {Object} 包含resources Array,以及events Array
     */
    function generateResourceArray(classList) {
        var resourcesList = []; //resource数组， return用
        var eventsList = []; //event数组， return用
        var resCount = 0; //用来生成resource的ID
        var eventCount = 0; //用来生成event的ID
        classList.forEach(function (classListByDate, indexByDate, thisArrayClassList) {
            //classListByDateByMac 每天 数台模拟机里的课程列表
            /*每一天里，按不同的模拟机遍历*/
            classListByDate.dayClass.forEach(function (classListByDateByMac, indexDateByMac, thisArrayByDateByMac) {
                //classListByDateByMac 每天 每一台模拟机里的课程列表
                resCount++;
                var resourceObj = {};
                resourceObj.id = resCount;
                resourceObj.date = classListByDate.date;
                resourceObj.machineNO = classListByDateByMac.machineNO;
                resourcesList.push(resourceObj);
                //遍历每一天里每一台模拟机里的每一节课
                classListByDateByMac.clas.forEach(function (classFinal, indexFinal, thisArrayFinal) {
                    eventCount++;
                    var eventObj = {};
                    /*用时间戳做ID*/
                    eventObj.id = parseInt(moment().format('x')) + eventsList.length;
                    eventObj.resourceId = resCount; //课程对应的模拟机ID
                    eventObj.isDiyClassTime = classFinal.isDiyClassTime;
                    /*课程时间设置*/
                    var startEndTimeObj = turnOrderToDisplayTime(classFinal.classOrder, classFinal.classDuration);
                    //turnDisplayTimeToOrder(startEndTimeObj.start, startEndTimeObj.end);
                    eventObj.start = startEndTimeObj.start; //课程开始时间
                    eventObj.end = startEndTimeObj.end; //课程结束时间
                    eventObj.students = classFinal.students; //课程的学生
                    eventObj.teachers = classFinal.teachers; //课程的老师
                    eventObj.inspectors = classFinal.inspectors; //课程的检查员
                    eventObj.log = classFinal.log; //课程的log
                    eventsList.push(eventObj);
                });
            });
        });
        return {
            resourcesList: resourcesList,
            eventsList: eventsList
        };
    }
    /**
     * @desc 创建一个eventResource
     * @params 自建event对象
     * @return 返回一个规定格式的event数组
     * */
    function generateEventResource(eventObj) {
        var eventArray = [eventObj];
        return eventArray;
    }
    /**
     * @通过id返回map,数组需要满足对象的键要求
     * @param array {Array}
     *
     * */
    function getArrayMapById(array) {
        var obj = {};
        array.forEach(function (item, index, thisArray) {
            obj[item.id] = index;
        });
        return obj;
    }

    /**
     * @desc 事件挂载到日历dom之前的拦截编辑
     * @params event $element view
     * */
    function eventRenderfun (event, $element, view) {
        //console.log(event);
        //如果是从模板拖拽进来的需要做额外处理，把模板数组里的事件，加入到事件数组中，并重新生成模板的id
        if (event.isDragFromExternal) {
            var thisTpl = tplList[tplListMap[event.id]];
            console.log(tplListMap, event.id);
            var eventsListItem = {
                id: thisTpl.id,
                resourceId: parseInt(event.resourceId), //对应哪一个resource
                start: moment(event.start.format()).format(),
                end: moment(event.end.format()).format(),
                title: event.title,
                log: thisTpl.log,
                students: thisTpl.students,
                teachers: thisTpl.teachers,
                inspectors: thisTpl.inspectors
            };
            addEventToEventsList(eventsListItem);
            //重置模板的ID
            thisTpl.id = parseInt(moment().format('x')) + eventsList.length; //用时间戳作为ID
        }
        /*复制显示模板*/
        var $tpl = $("#template>.box-wrap").clone();
        //插入学员
        //console.log(Dateobj.eventsList[eventsListMap[event.id]]);
        Dateobj.eventsList[eventsListMap[event.id]].students.forEach(function (student, index, studentsArray) {
            var $student = $('<span class="card-item"> </span>');
            $student.text(student.name);
            $tpl.find('.student').append($student);
        });
        //插入老师
        Dateobj.eventsList[eventsListMap[event.id]].teachers.forEach(function (teacher, index, teachersArray) {
            var $teacher = $('<span class="card-item"> </span>');
            $teacher.text(teacher.name);
            $tpl.find('.teacher').append($teacher);
        });
        //插入检查员
        Dateobj.eventsList[eventsListMap[event.id]].inspectors.forEach(function (inspector, index, inspectorsArray) {
            var $inspector = $('<span class="card-item"> </span>');
            $inspector.text(inspector.name);
            $tpl.find('.inspector').append($inspector);
        });
/*        //插入id
        var $id = $('<span class="card-item"> </span>');
        $id.text('eventid' + event.id);
        $tpl.find('.log').append($id);*/
        //插入log
        var $log = $('<span class=""> </span>');
        $log.text(Dateobj.eventsList[eventsListMap[event.id]].log);
        $tpl.find('.log').append($log);
        $element.find(".fc-content>span.fc-title").remove(); //剔除fullcalendar默认的显示元素
        $element.find(".fc-content").append($tpl); /*完成渲染元素的编辑*/
    }
    /**
     * @desc 打开layer新建框 新建事件
     * @params start 开始事件 end 结束时间 resource 对应的resource
     */
    function openCreateLayer (start, end, resource) {
        layer.open({
            title: '新建课程',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['500px',''],
            btn:["保存","取消"],
            success:function($layDom){
                //重置表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
            },
            yes: function(index, $layDom){
                //生成事件对象
                var eventData = {
                    id: parseInt(moment().format('x')) + eventsList.length, //用时间戳作为ID
                    resourceId: resource.id,
                    start: start,
                    end: end
                };
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');

                //向统一的事件库加入事件资源
                var eventsListItem = {
                    id: eventData.id,
                    resourceId: parseInt(resource.id), //对应哪一个resource
                    start: moment(start.format()).format(), //日历上需要用的时间
                    end: moment(end.format()).format(),
                    title: 'title',
                    log: $layDom.find('#input-log').val(),
                    students: students,
                    teachers: teachers,
                    inspectors: inspectors
                };
                //是否diyTime，并设置自定义时间
                if ($('#is-diy-time').prop('checked')) {
                    eventsListItem.isDiyClassTime = 1;
                    eventsListItem.diyTimeStart =  $layDom.find('#class-time-start').val();
                    eventsListItem.diyTimeEnd =  $layDom.find('#class-time-end').val();
                } else {
                    eventsListItem.isDiyClassTime = 0;
                }
                eventsList.push(eventsListItem); //像资源库push新事件
                eventsListMap = getArrayMapById(eventsList);//重新生成map
                console.log(eventsListItem);
                //console.log($('#select-students').select2('data'));
                //在日历上添加事件
                $('#calendar').fullCalendar( 'renderEvent', eventData , 'stick');
                $('#calendar').fullCalendar('unselect');
                layer.close(layer.index);
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
            }
        });
    }
    /**
     * @desc 打开layer编辑框，编辑事件
     * @params
     */
    function openEditLayer (event, element) {
        layer.open({
            title: '编辑',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['500px',''],
            btn:["保存", "删除", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                /*填充已经存在的人员*/
                /*格式化select2选出的人员的val*/
                var studentsVal = $.map(eventsList[eventsListMap[event.id]].students, function (obj) {
                    return obj.pCode;
                });
                var teachersVal = $.map(eventsList[eventsListMap[event.id]].teachers, function (obj) {
                    return obj.pCode;
                });
                var inspectorsVal = $.map(eventsList[eventsListMap[event.id]].inspectors, function (obj) {
                    return obj.pCode;
                });
                $('#select-students').val(studentsVal).trigger('change');
                $('#select-teachers').val(teachersVal).trigger('change');
                $('#select-inspectors').val(inspectorsVal).trigger('change');
                $layDom.find('#input-log').val(eventsList[eventsListMap[event.id]].log);
                /*填充自定义时间*/
                if (eventsList[eventsListMap[event.id]].isDiyClassTime == 1) {
                    $('#is-diy-time').prop('checked', true).trigger('change');
                    $layDom.find('#class-time-start').val(eventsList[eventsListMap[event.id]].diyTimeStart);
                    $layDom.find('#class-time-end').val(eventsList[eventsListMap[event.id]].diyTimeEnd);
                } else {
                    $('#is-diy-time').prop('checked', false);
                }
            },
            yes: function(index, $layDom){
                //生成事件对象
                var eventData = {
                    id: event.id, //用时间戳作为ID
                    resourceId: event.resourceId,
                    start: event.start,
                    end: event.end
                };
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');
                //向统一的事件库加入事件资源
                var eventsListItem = {
                    id: eventData.id,
                    resourceId: parseInt(eventData.resourceId), //对应哪一个resource
                    start: event.start.format(),
                    end: event.end.format(),
                    title: 'title',
                    log: $layDom.find('#input-log').val(),
                    students: students,
                    teachers: teachers,
                    inspectors: inspectors
                };
                //是否diyTime，并设置自定义时间
                if ($('#is-diy-time').prop('checked')) {
                    eventsListItem.isDiyClassTime = 1;
                    eventsListItem.diyTimeStart =  $layDom.find('#class-time-start').val();
                    eventsListItem.diyTimeEnd =  $layDom.find('#class-time-end').val();
                } else {
                    eventsListItem.isDiyClassTime = 0;
                }
                eventsList[eventsListMap[event.id]] = eventsListItem; //替换修改的事件
                eventsListMap = getArrayMapById(eventsList);//重新生成map
                //删除事件
                $('#calendar').fullCalendar( 'removeEvents', event.id); /*根据id删除事件*/
                //添加事件
                $('#calendar').fullCalendar( 'renderEvent', eventData , 'stick');
                $('#calendar').fullCalendar('unselect');
                layer.close(layer.index);
            },
            /*删除按钮*/
            btn2: function (index, $layDom) {
                $('#calendar').fullCalendar( 'removeEvents', event.id); /*根据id删除事件*/
                eventsList.splice(eventsListMap[event.id], 1); //删除事件
                eventsListMap = getArrayMapById(eventsList); //重新生成map
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
            }
        });
    }
    /**
     * @desc 创建新模板
     * */
    function openLayerCreateTpl () {
        layer.open({
            title: '新建模板',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['500px',''],
            btn:["保存", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                hideInTpl(); //隐藏自定义时间选项
            },
            yes: function(index, $layDom){
                //tplList
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');
                //向模板库加入模板资源，此时定义id
                var TplListItem = {
                    id: parseInt(moment().format('x')) + eventsList.length, //用时间戳作为ID
                    title: 'title',
                    log: $layDom.find('#input-log').val(),
                    students: students,
                    teachers: teachers,
                    inspectors: inspectors
                };
                tplList.splice(tplList.length,0,TplListItem); //添加模板元素
                tplListMap = getArrayMapById(tplList);//重新生成map
                layer.close(layer.index);
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                showInTpl(); //显示自定义时间选项
            }
        });
    }
    /**
     * @desc 编辑模板
     *
     * */
    function openLayerEditTpl(item) {
        console.log(item);
        layer.open({
            title: '编辑模板',
            type: 1,
            skin: '', //样式类名
            zIndex: 800,
            area: ['500px',''],
            btn:["保存", "删除", "取消"],
            success:function($layDom){
                //重置select2、以及表单
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                hideInTpl(); //隐藏自定义时间选项
                /*填充已经存在的人员*/
                /*格式化select2选出的人员的val*/
                var thisTpl = tplList[tplListMap[event.id]];
                var studentsVal = $.map(item.students, function (obj) {
                    return obj.pCode;
                });
                var teachersVal = $.map(item.teachers, function (obj) {
                    return obj.pCode;
                });
                var inspectorsVal = $.map(item.inspectors, function (obj) {
                    return obj.pCode;
                });
                $('#select-students').val(studentsVal).trigger('change');
                $('#select-teachers').val(teachersVal).trigger('change');
                $('#select-inspectors').val(inspectorsVal).trigger('change');
                $layDom.find('#input-log').val(item.log);
            },
            yes: function(index, $layDom){
                //tplList
                /*格式化select2选出的人员*/
                var students = formatSelect2Result('#select-students');
                var teachers = formatSelect2Result('#select-teachers');
                var inspectors = formatSelect2Result('#select-inspectors');
                //修改模板库的模板
                item.log = $layDom.find('#input-log').val();
                item.students = students;
                item.teachers = teachers;
                item.inspectors = inspectors;
                layer.close(layer.index);
            },
            /*删除按钮*/
            btn2: function (index, $layDom) {
                $('#calendar').fullCalendar( 'removeEvents', event.id); /*根据id删除事件*/
                eventsList.splice(eventsListMap[event.id], 1); //删除事件
                eventsListMap = getArrayMapById(eventsList); //重新生成map
            },
            content: $("#layer-body"),
            end: function () {
                //重置select2
                resetSelect2(['#select-students', '#select-teachers', '#select-inspectors']);
                showInTpl(); //显示自定义时间选项
            }
        });
    }
    /**
     * @desc 向统一的事件库加入事件资源
     * @param eventGeneObj {Object} 包含所有必须事件信息的对象
     */
    function addEventToEventsList (eventGeneObj) {
        eventsList.push(eventGeneObj);
        eventsListMap = getArrayMapById(eventsList);//重新生成map
        tplListMap = getArrayMapById(tplList);
    }


    /**
     * @desc 课程时间的转化，把classOrder、classDuration转换成插件可以识别的时间，从而渲染
     * @param classOrder 课程开始的节数
     * @param classDuration 课程持续的节数
     * @returns {{start: string, end: string}}
     * 均是通过moment转化的带+08:00的时间字符串，日历插件渲染用
     */
    function turnOrderToDisplayTime (classOrder, classDuration) {
        var start = moment.duration(timeLineOpt.minTime);
        var end = moment.duration(timeLineOpt.minTime);
        for ( var i =1; i < classOrder; i++){
            start.add(moment.duration(timeLineOpt.slotDuration));
            end.add(moment.duration(timeLineOpt.slotDuration));
        }
        end.add(moment.duration(classDuration));
        //注意 add方法是直接在对象上操作，会改变对象，而不是返回值
        var baseTimeStart = moment(thisDate + 'T00:00:00+08:00');
        var baseTimeEnd = moment(thisDate + 'T00:00:00+08:00');
        return {
            start: baseTimeStart.add(start).toJSON(), //课程开始时间,
            end: baseTimeEnd.add(end).toJSON() //课程结束时间
        }
    }
    /**
     * @desc 通过日历插件中的起始时间，计算课程的 classOrder, classDuration
     * @param start {String} 可以转换成+08:00时间对象的时间字符串
     * @param end {String} 可以转换成+08:00时间对象的时间字符串
     * @return {{classOrder: int, classDuration: int}}
     */
    function turnDisplayTimeToOrder(start, end) {
        var classOrder = 1;
        var classDurationTimes = 0; //是slotDuration的多少倍
        var classDuration = {hours: 0, minutes: 0};
        var minDuration = moment.duration(timeLineOpt.slotDuration);
        //从最初时间到课程开始的duration
        //计算classOrder
        var startDuration =  moment.duration(moment(start).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        var endDuration =  moment.duration(moment(end).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        //console.log(moment.duration(startDuration).asSeconds(),minDuration.asSeconds());
        while (startDuration.asSeconds() != 0) {
            classOrder++;
            startDuration.subtract(minDuration);
        }
        //计算classDuration
        startDuration =  moment.duration(moment(start).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        endDuration =  moment.duration(moment(end).valueOf() - moment(thisDate + 'T00:00:00+08:00').valueOf());
        endDuration.subtract(startDuration);
        while (endDuration.asSeconds() != 0) {
            classDurationTimes++;
            endDuration.subtract(minDuration);
        }
        for (var i = 0;i < classDurationTimes;i++){
            classDuration.hours += timeLineOpt.slotDuration.hours;
            classDuration.minutes += timeLineOpt.slotDuration.minutes;
        }
        //console.log(classOrder, classDuration, classDurationTimes);
        return{
            classOrder: classOrder,
            classDuration: classDuration
        }
    }
    /**
     * @desc 在eventsList中改变drag或者resize事件的时间参数
     * @param event
     * @return {Object} 改变的start和end
     */
    function changeEventTime (event) {
        eventsList[eventsListMap[event.id]].start = event.start.format();
        eventsList[eventsListMap[event.id]].end = event.end.format();
        return {
            start: moment(event.start.format()).format(),
            end: moment(event.end.format()).format()
        }
    }
    /**
     * @desc 清理特定的select2的val 以及layer里的表单
     * @param array {Array} 包含需要清理的select2选择器的数组
     */
    function resetSelect2 (array) {
        array.forEach(function (selector, index, array) {
            $(selector).val(null).trigger('change');
        });
        $('#layer-body > form')[0].reset();
        $('#is-diy-time').prop('checked', false);
        $('#is-diy-time').trigger('change');
    }
    /**
     * @desc 把select2选出的项格式化
     * @param selector {String} jquery id选择器
     * @returns {Array}
     */
    function formatSelect2Result(selector) {
        return $.map($(selector).select2('data'), function (obj) {
            return {
                name: obj.text,
                pCode: obj.id
            }
        });
    }
    /**
     * @desc 隐藏自定义事件选项
     */
    function hideInTpl() {
        $('#diy-time-control').hide();
        $('#diy-time-wrap').hide();
    }
    /**
     * @desc 显示自定义事件选项
     */
    function showInTpl() {
        $('#diy-time-control').show();
        $('#diy-time-wrap').show();
    }
</script>
</body>
</html>